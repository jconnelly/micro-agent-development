<?xml version="1.0" encoding="UTF-8"?>
<!-- Business Process Model and Notation (BPMN) - Expense Approval Workflow -->
<!-- Contains business rules embedded within process flow definitions -->

<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  id="ExpenseApprovalProcess" 
                  targetNamespace="http://company.com/expense">

  <bpmn:process id="expense-approval" name="Expense Report Approval Process" isExecutable="true">
    
    <bpmn:startEvent id="expense-submitted" name="Expense Report Submitted">
      <bpmn:documentation>Employee submits expense report for approval</bpmn:documentation>
      <bpmn:outgoing>to-validation</bpmn:outgoing>
    </bpmn:startEvent>
    
    <!-- Initial Validation Business Rules -->
    <bpmn:businessRuleTask id="validate-expense" name="Validate Expense Report">
      <bpmn:documentation>
        Business Rules Applied:
        1. All receipts must be attached for expenses over $25
        2. Expense categories must be valid and authorized
        3. Expense dates must be within last 90 days
        4. Mileage claims require trip purpose and destination
        5. Meals cannot exceed $75/day unless international travel
        6. Hotel expenses require itemized bills, not just credit card receipts
        7. Personal expenses must be clearly marked and excluded
      </bpmn:documentation>
      <bpmn:incoming>to-validation</bpmn:incoming>
      <bpmn:outgoing>validation-result</bpmn:outgoing>
    </bpmn:businessRuleTask>
    
    <bpmn:exclusiveGateway id="validation-gateway" name="Validation Result">
      <bpmn:incoming>validation-result</bpmn:incoming>
      <bpmn:outgoing>validation-failed</bpmn:outgoing>
      <bpmn:outgoing>validation-passed</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- Rejection Path for Invalid Expenses -->
    <bpmn:userTask id="fix-expense-issues" name="Fix Expense Issues">
      <bpmn:documentation>
        Return to employee to fix validation issues:
        - Add missing receipts
        - Correct expense categories
        - Update expense dates
        - Provide additional documentation
        Employee has 5 business days to resubmit
      </bpmn:documentation>
      <bpmn:incoming>validation-failed</bpmn:incoming>
      <bpmn:outgoing>resubmitted</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- Amount-Based Routing Rules -->
    <bpmn:exclusiveGateway id="amount-gateway" name="Expense Amount Decision">
      <bpmn:documentation>
        Routing Rules Based on Total Amount:
        - Under $100: Auto-approve if employee is trusted
        - $100-$500: Manager approval required
        - $500-$2000: Department head approval required  
        - $2000-$5000: VP approval required
        - Over $5000: CFO approval required
        - International travel: Always requires VP approval regardless of amount
        - Conference/training: Requires prior approval verification
      </bpmn:documentation>
      <bpmn:incoming>validation-passed</bpmn:incoming>
      <bpmn:incoming>resubmitted</bpmn:incoming>
      <bpmn:outgoing>auto-approve-flow</bpmn:outgoing>
      <bpmn:outgoing>manager-approval-flow</bpmn:outgoing>
      <bpmn:outgoing>department-head-flow</bpmn:outgoing>
      <bpmn:outgoing>vp-approval-flow</bpmn:outgoing>
      <bpmn:outgoing>cfo-approval-flow</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- Auto-Approval Path -->
    <bpmn:serviceTask id="auto-approve" name="Auto-Approve Small Expenses">
      <bpmn:documentation>
        Auto-approval criteria:
        - Total amount under $100
        - Employee trust level: Gold or Platinum
        - No policy violations in last 12 months
        - All receipts properly attached
        - Standard business categories only
        Automatically approved and sent to payroll
      </bpmn:documentation>
      <bpmn:incoming>auto-approve-flow</bpmn:incoming>
      <bpmn:outgoing>to-payroll</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Manager Approval -->
    <bpmn:userTask id="manager-approval" name="Manager Review and Approval">
      <bpmn:documentation>
        Manager approval requirements ($100-$500):
        - Review expense categories for business necessity
        - Verify receipts match expense descriptions
        - Check for duplicate submissions
        - Ensure compliance with department budget
        - Review entertainment expenses for business purpose
        Manager has 3 business days to approve/reject
      </bpmn:documentation>
      <bpmn:incoming>manager-approval-flow</bpmn:incoming>
      <bpmn:outgoing>manager-decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- Department Head Approval -->
    <bpmn:userTask id="dept-head-approval" name="Department Head Review">
      <bpmn:documentation>
        Department head approval requirements ($500-$2000):
        - All manager approval criteria plus:
        - Check against annual department budget
        - Review travel policy compliance
        - Verify pre-approval for conferences/training
        - Cross-reference with project codes/cost centers
        - Ensure no unauthorized equipment purchases
        Department head has 5 business days to review
      </bpmn:documentation>
      <bpmn:incoming>department-head-flow</bpmn:incoming>
      <bpmn:outgoing>dept-head-decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- VP Approval -->
    <bpmn:userTask id="vp-approval" name="Vice President Review">
      <bpmn:documentation>
        VP approval requirements ($2000-$5000 or international):
        - All previous approval criteria plus:
        - Strategic alignment with business objectives
        - International travel safety and necessity review
        - High-value equipment/software justification
        - Client entertainment approval and limits
        - Compliance with corporate expense policies
        VP has 7 business days to review
      </bpmn:documentation>
      <bpmn:incoming>vp-approval-flow</bpmn:incoming>
      <bpmn:outgoing>vp-decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- CFO Approval -->
    <bpmn:userTask id="cfo-approval" name="CFO Final Approval">
      <bpmn:documentation>
        CFO approval requirements (over $5000):
        - All previous approval criteria plus:
        - Impact on quarterly financial projections
        - Extraordinary expense justification
        - Board reporting requirements
        - Tax implications review
        - Audit trail documentation
        CFO has 10 business days to review
      </bpmn:documentation>
      <bpmn:incoming>cfo-approval-flow</bpmn:incoming>
      <bpmn:outgoing>cfo-decision</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- Decision Consolidation -->
    <bpmn:exclusiveGateway id="final-decision" name="Final Approval Decision">
      <bpmn:incoming>manager-decision</bpmn:incoming>
      <bpmn:incoming>dept-head-decision</bpmn:incoming>
      <bpmn:incoming>vp-decision</bpmn:incoming>
      <bpmn:incoming>cfo-decision</bpmn:incoming>
      <bpmn:outgoing>approved</bpmn:outgoing>
      <bpmn:outgoing>rejected</bpmn:outgoing>
      <bpmn:outgoing>needs-modification</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- Approval Processing -->
    <bpmn:serviceTask id="process-approval" name="Process Approved Expense">
      <bpmn:documentation>
        Approval processing business rules:
        - Generate approval reference number
        - Update employee expense tracking
        - Create accounting entries with proper cost centers
        - Schedule payment based on company payment cycle
        - Update budget tracking systems
        - Send confirmation to employee and manager
        - Archive all documentation for audit trail
      </bpmn:documentation>
      <bpmn:incoming>approved</bpmn:incoming>
      <bpmn:incoming>to-payroll</bpmn:incoming>
      <bpmn:outgoing>to-payment</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Rejection Processing -->
    <bpmn:serviceTask id="process-rejection" name="Process Rejection">
      <bpmn:documentation>
        Rejection processing rules:
        - Document specific rejection reasons
        - Notify employee via email with detailed explanation
        - Provide policy reference links
        - Offer resubmission guidelines
        - Update employee expense history
        - Flag repeated policy violations for HR review
      </bpmn:documentation>
      <bpmn:incoming>rejected</bpmn:incoming>
      <bpmn:outgoing>rejection-complete</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Modification Request -->
    <bpmn:userTask id="modify-expense" name="Modify and Resubmit">
      <bpmn:documentation>
        Modification requirements:
        - Employee must address specific feedback
        - Partial approvals require splitting expense report
        - Questionable items must be justified or removed
        - Additional documentation may be required
        - Modified reports restart approval process
        Employee has 10 business days to modify and resubmit
      </bpmn:documentation>
      <bpmn:incoming>needs-modification</bpmn:incoming>
      <bpmn:outgoing>modified-resubmit</bpmn:outgoing>
    </bpmn:userTask>
    
    <!-- Payment Processing -->
    <bpmn:businessRuleTask id="payment-processing" name="Process Payment">
      <bpmn:documentation>
        Payment processing business rules:
        - Standard payment: Next monthly payment cycle
        - Urgent payment: 3-5 business days (manager override required)
        - International reimbursement: Currency conversion at expense date rate
        - Direct deposit preferred, check if no banking info
        - Tax reporting for payments over $600 annually
        - Update employee year-to-date expense totals
      </bpmn:documentation>
      <bpmn:incoming>to-payment</bpmn:incoming>
      <bpmn:outgoing>payment-complete</bpmn:outgoing>
    </bpmn:businessRuleTask>
    
    <!-- Audit Trail -->
    <bpmn:serviceTask id="audit-logging" name="Update Audit Trail">
      <bpmn:documentation>
        Audit logging requirements:
        - Complete approval workflow history
        - All decision makers and timestamps  
        - Policy violations and resolutions
        - Document retention for 7 years
        - Compliance reporting data
        - Integration with expense analytics system
      </bpmn:documentation>
      <bpmn:incoming>payment-complete</bpmn:incoming>
      <bpmn:incoming>rejection-complete</bpmn:incoming>
      <bpmn:outgoing>process-complete</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- End Events -->
    <bpmn:endEvent id="process-completed" name="Process Completed">
      <bpmn:incoming>process-complete</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- Escalation Rules -->
    <bpmn:boundaryEvent id="approval-timeout" name="Approval Timeout" attachedToRef="manager-approval">
      <bpmn:documentation>
        Escalation rules for delayed approvals:
        - Manager approval: Escalate to department head after 3 days
        - Department head: Escalate to VP after 5 days  
        - VP approval: Escalate to CFO after 7 days
        - CFO approval: Escalate to CEO after 10 days
        - Auto-approve routine expenses after 14 days of inactivity
        - Notify all parties in escalation chain
      </bpmn:documentation>
      <bpmn:timerEventDefinition>
        <bpmn:timeDuration>P3D</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
      <bpmn:outgoing>escalate-approval</bpmn:outgoing>
    </bpmn:boundaryEvent>
    
    <bpmn:serviceTask id="escalate-approval" name="Escalate Approval">
      <bpmn:incoming>escalate-approval</bpmn:incoming>
      <bpmn:outgoing>escalated-to-higher-level</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Sequence Flows -->
    <bpmn:sequenceFlow id="to-validation" sourceRef="expense-submitted" targetRef="validate-expense"/>
    <bpmn:sequenceFlow id="validation-result" sourceRef="validate-expense" targetRef="validation-gateway"/>
    <bpmn:sequenceFlow id="validation-failed" sourceRef="validation-gateway" targetRef="fix-expense-issues">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{expenseValidation.hasErrors()}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="validation-passed" sourceRef="validation-gateway" targetRef="amount-gateway">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{!expenseValidation.hasErrors()}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="resubmitted" sourceRef="fix-expense-issues" targetRef="amount-gateway"/>
    
    <!-- Amount-based routing -->
    <bpmn:sequenceFlow id="auto-approve-flow" sourceRef="amount-gateway" targetRef="auto-approve">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{expense.totalAmount < 100 && employee.trustLevel >= 'GOLD'}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="manager-approval-flow" sourceRef="amount-gateway" targetRef="manager-approval">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{expense.totalAmount >= 100 && expense.totalAmount < 500}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="department-head-flow" sourceRef="amount-gateway" targetRef="dept-head-approval">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{expense.totalAmount >= 500 && expense.totalAmount < 2000}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="vp-approval-flow" sourceRef="amount-gateway" targetRef="vp-approval">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{(expense.totalAmount >= 2000 && expense.totalAmount < 5000) || expense.isInternationalTravel()}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="cfo-approval-flow" sourceRef="amount-gateway" targetRef="cfo-approval">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">
        #{expense.totalAmount >= 5000}
      </bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <!-- Decision flows -->
    <bpmn:sequenceFlow id="to-payroll" sourceRef="auto-approve" targetRef="process-approval"/>
    <bpmn:sequenceFlow id="manager-decision" sourceRef="manager-approval" targetRef="final-decision"/>
    <bpmn:sequenceFlow id="dept-head-decision" sourceRef="dept-head-approval" targetRef="final-decision"/>
    <bpmn:sequenceFlow id="vp-decision" sourceRef="vp-approval" targetRef="final-decision"/>
    <bpmn:sequenceFlow id="cfo-decision" sourceRef="cfo-approval" targetRef="final-decision"/>
    
    <!-- Final processing -->
    <bpmn:sequenceFlow id="approved" sourceRef="final-decision" targetRef="process-approval">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">#{approvalDecision == 'APPROVED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="rejected" sourceRef="final-decision" targetRef="process-rejection">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">#{approvalDecision == 'REJECTED'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="needs-modification" sourceRef="final-decision" targetRef="modify-expense">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">#{approvalDecision == 'NEEDS_MODIFICATION'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="to-payment" sourceRef="process-approval" targetRef="payment-processing"/>
    <bpmn:sequenceFlow id="rejection-complete" sourceRef="process-rejection" targetRef="audit-logging"/>
    <bpmn:sequenceFlow id="modified-resubmit" sourceRef="modify-expense" targetRef="amount-gateway"/>
    <bpmn:sequenceFlow id="payment-complete" sourceRef="payment-processing" targetRef="audit-logging"/>
    <bpmn:sequenceFlow id="process-complete" sourceRef="audit-logging" targetRef="process-completed"/>
    <bpmn:sequenceFlow id="escalated-to-higher-level" sourceRef="escalate-approval" targetRef="dept-head-approval"/>
    
  </bpmn:process>
  
</bpmn:definitions>